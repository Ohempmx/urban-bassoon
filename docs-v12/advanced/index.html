<!doctype html>
<title>
  
    Advanced Usage | Node Tap
  
</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html {
  display: block;
  font-family: sans-serif;
  padding: 0 1em;
  margin: 0 auto;
  border-top: 10px solid #f7df1e;
  line-height:1.5;
  color:#333;
  position:relative;
}

html::before {
  width:100%;
  display:block;
  position:fixed;
  top:0;
  left:0;
  height:10px;
  background:#f7df1e;
  content: " ";
}

body {
  padding:0;
  margin: 0;
}

a:hover, a:active, a:focus {
  color: red;
}

code, pre, kbd {
  font-size: 100%;
  font-family: Triplicate T4, Fira Mono OT, Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

section.side {
  display: block;
  padding:0;
  min-height:100px;
  margin: 0;
  width:100%;
}

.side h2, .side p {
  margin-top: 0;
}

section.side li {
  display: inline;
}

section.side ul {
  display: block;
  overflow:auto;
}

section.side li ul {
  display: inline;
}

.side ul {
  padding:0;
  margin:0 ;
}

.side img {
  display: block;
  margin-right: 1em;
  margin-top: 1em;
}

section.main {
  display: block;
  padding-top:20px;
}

@media only screen and (min-width: 240px) {
  .side img {
    float:left;
    margin: 0 1em 0 0;
  }
}

@media only screen and (min-width: 800px) {
  html {
    width:600px;
    padding:0 0 0 200px;
  }
  section.side {
    width: 200px;
    position: fixed;
    margin: 0 0 0 -200px;
  }
  .side img {
    display: block;
    float:none;
  }

  section.side ul {
    overflow: none;
    display: block;
  }

  section.side li {
    display: block;
  }

  section.side a {
    display: block;
  }

  section.side li ul {
    margin: 0;
    display: block;
  }

  section.side li li {
    margin-left: 1em;
  }

  .side h2, .side p {
    margin-top: 1em;
  }

  section.main {
    float: right;
    width: 600px;
    padding-bottom: 100px;
  }
}
</style>
<link href="../static/prism.css" rel="stylesheet">

<body>

<section class='side'>
  <h2><a href="../index.html"><img src='../static/tapjs.png' width=100 height=100 alt='Test Anything JS'></a></h2>
  <p>A Test-Anything-Protocol library for Node.js</p>
  <ul>
  
    <li>
      <a href="../index.html">Index</a>
      
    </li>
  
    <li>
      <a href="../basics/index.html">Getting Started</a>
      
    </li>
  
    <li>
      <a href="../api/index.html">API</a>
      
      <ul>
        
        <li><a href="../asserts/index.html">Asserts</a></li>
        
        <li><a href="../promises/index.html">Promises</a></li>
        
        <li><a href="../subtests/index.html">Subtests</a></li>
        
        <li><a href="../parallel/index.html">Parallel Tests</a></li>
        
        <li><a href="../snapshots/index.html">Snapshot Testing</a></li>
        
        <li><a href="../grep/index.html">Filtering Tests: grep</a></li>
        
        <li><a href="../only/index.html">Filtering Tests: only</a></li>
        
        <li><a href="../mochalike/index.html">Mocha-like DSL</a></li>
        
        <li><a href="index.html">Advanced</a></li>
        
      </ul>
      
    </li>
  
    <li>
      <a href="../cli/index.html">CLI</a>
      
    </li>
  
    <li>
      <a href="../tap-format.1">The Protocol</a>
      
    </li>
  
    <li>
      <a href="../reporting/index.html">Reporting</a>
      
    </li>
  
    <li>
      <a href="../coverage/index.html">Coverage</a>
      
    </li>
  
    <li>
      <a href="../changelog/index.html">Change Log</a>
      
    </li>
  
    <li>
      <a href="https://github.com/tapjs/node-tap">GitHub Repo</a>
      
    </li>
  
  </ul>
  <pre><a href="http://npm.im/tap">npm install tap</a>
<a href="../cli/index.html">tap test/*.js</a></pre>
</section>
<section class='main'>
<h1 id="advanced-usage">Advanced Usage</h1>

<p>These methods are primarily for internal use, but can be handy in some
unusual situations.  If you find yourself using them frequently, you
<em>may</em> be Doing It Wrong.  However, if you find them useful, you should
feel perfectly comfortable using them.</p>

<p>Please <a href="https://github.com/isaacs/node-tap/issues">let us know</a> if you
frequently encounter situations requiring advanced usage, because this
may indicate a shortcoming in the “non-advanced” <a href="../api/index.html">API</a>.</p>

<h2 id="class-tspawn">Class: t.Spawn()</h2>

<p>Similar to the <code class="highlighter-rouge">Test</code> class, but instead of a callback that gets a
object with assertion methods, it starts a child process and parses its
output.</p>

<h2 id="class-tstdin">Class: t.Stdin()</h2>

<p>Similar to the <code class="highlighter-rouge">Test</code> class, but instead of a callback that gets a
object with assertion methods, it reads the process standard input,
and parses that as <a href="../tap-format.1">TAP</a>-formatted data.</p>

<h2 id="tstdin">t.stdin()</h2>

<p>Parse standard input as if it was a child test named <code class="highlighter-rouge">/dev/stdin</code>.</p>

<p>Returns a Promise which resolves with the parent when the input stream
is completed.</p>

<p>This is primarily for use in the test runner, so that you can do
<code class="highlighter-rouge">some-tap-emitting-program | tap other-file.js - -Rnyan</code>.</p>

<h2 id="tspawncommand-arguments-options-name">t.spawn(command, arguments, [options], [name])</h2>

<p>Sometimes, instead of running a child test directly inline, you might
want to run a TAP producting test as a child process, and treat its
standard output as the TAP stream.</p>

<p>Returns a Promise which resolves with the parent when the child
process is completed.</p>

<p>That’s what this method does.</p>

<p>It is primarily used by the executable runner, to run all of the
filename arguments provided on the command line.</p>

<p>The <code class="highlighter-rouge">options</code> object is passed to <code class="highlighter-rouge">child_process.spawn</code>, and can
contain stuff like stdio directives and environment vars.  It’s also
where you put the same fields that would be passed to any assertion or
child test:</p>

<ul>
  <li><code class="highlighter-rouge">bail</code>: Set to <code class="highlighter-rouge">true</code> to bail out on the first failure.  This is
done by checking the output and then forcibly killing the process,
but also sets the <code class="highlighter-rouge">TAP_BAIL</code> environment variable, which node-tap
uses to set this field internally as well.</li>
  <li><code class="highlighter-rouge">timeout</code>: The number of ms to allow the child process to continue.
If it goes beyond this time, the child process will be forcibly
killed.</li>
  <li><code class="highlighter-rouge">todo</code> Set to boolean <code class="highlighter-rouge">true</code> or a String to mark this as pending.</li>
  <li><code class="highlighter-rouge">skip</code> Set to boolean <code class="highlighter-rouge">true</code> or a String to mark this as skipped.</li>
  <li><code class="highlighter-rouge">bail</code> Set to boolean <code class="highlighter-rouge">true</code> to bail out on the first test failure.</li>
  <li><code class="highlighter-rouge">diagnostic</code> Set to <code class="highlighter-rouge">true</code> to show a yaml diagnostic block even if
the test passes.  Set to <code class="highlighter-rouge">false</code> to never show a yaml diagnostic
block.</li>
  <li><code class="highlighter-rouge">buffered</code> Set to <code class="highlighter-rouge">true</code> to run as a buffered <a href="../subtests/index.html">subtest</a>.
Set to <code class="highlighter-rouge">false</code> to run as an indented subtest.  The default is
<code class="highlighter-rouge">false</code> unless <code class="highlighter-rouge">TAP_BUFFER=1</code> is set in the environment.</li>
</ul>

<h2 id="taddassertname-length-fn">t.addAssert(name, length, fn)</h2>

<p>This is used for creating assertion methods on the <code class="highlighter-rouge">Test</code> class.</p>

<p>It’s a little bit advanced, but it’s also super handy sometimes.  All
of the assert methods below are created using this function, and it
can be used to create application-specific assertions in your tests.</p>

<p>The name is the method name that will be created.  The length is the
number of arguments the assertion operates on.  (The <code class="highlighter-rouge">message</code> and
<code class="highlighter-rouge">extra</code> arguments will always be appended to the end.)</p>

<p>For example, you could have a file at <code class="highlighter-rouge">test/setup.js</code> that does the
following:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">tap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>

<span class="c1">// convenience</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">module</span> <span class="o">===</span> <span class="nx">require</span><span class="p">.</span><span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">tap</span><span class="p">.</span><span class="nx">pass</span><span class="p">(</span><span class="s1">'ok'</span><span class="p">)</span>
  <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// Add an assertion that a string is in Title Case</span>
<span class="c1">// It takes one argument (the string to be tested)</span>
<span class="nx">tap</span><span class="p">.</span><span class="nx">Test</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addAssert</span><span class="p">(</span><span class="s1">'titleCase'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">extra</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span> <span class="o">||</span> <span class="s1">'should be in Title Case'</span>
  <span class="c1">// the string in Title Case</span>
  <span class="c1">// A fancier implementation would avoid capitalizing little words</span>
  <span class="c1">// to get `Silence of the Lambs` instead of `Silence Of The Lambs`</span>
  <span class="c1">// But whatever, it's just an example.</span>
  <span class="kd">var</span> <span class="nx">tc</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\b</span><span class="sr">./</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">match</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="c1">// should always return another assert call, or</span>
  <span class="c1">// this.pass(message) or this.fail(message, extra)</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">tc</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">extra</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Then in your individual tests, you’d do this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">require</span><span class="p">(</span><span class="s1">'./setup.js'</span><span class="p">)</span> <span class="c1">// adds the assert</span>
<span class="kd">var</span> <span class="nx">tap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>
<span class="nx">tap</span><span class="p">.</span><span class="nx">titleCase</span><span class="p">(</span><span class="s1">'This Passes'</span><span class="p">)</span>
<span class="nx">tap</span><span class="p">.</span><span class="nx">titleCase</span><span class="p">(</span><span class="s1">'however, tHis tOTaLLy faILS'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="tendall">t.endAll()</h2>

<p>Call the <code class="highlighter-rouge">end()</code> method on all child tests, and then on this one.</p>

<h2 id="tassertat-tassertstack-extraat-extrastack">t.assertAt, t.assertStack, extra.at, extra.stack</h2>

<p>The Test object will try to work out the most useful <code class="highlighter-rouge">stack</code> and <code class="highlighter-rouge">at</code>
options to tell you where a failing assertion was made.</p>

<p>In very rare and interesting cases, you <em>may</em> wish to override this
for some reason.  For example, you may be wrapping tap.Test object
methods, and wish to show the user where they called your method,
rather than showing where your method called into tap.</p>

<p>You can do this in two possible ways:</p>

<ol>
  <li>Set the <code class="highlighter-rouge">at</code> and/or <code class="highlighter-rouge">stack</code> properties on the <code class="highlighter-rouge">extra</code> object passed to
assert methods.</li>
  <li>Set the <code class="highlighter-rouge">t.assertAt</code> and/or <code class="highlighter-rouge">t.assertStack</code> properties on the
Test object immediately before calling the assertion method.  The
values are consumed and deleted when the next assertion is called.</li>
</ol>

<p>The <code class="highlighter-rouge">at</code> property should be an object with the following properties at
minimum:</p>

<ul>
  <li><code class="highlighter-rouge">file</code> - The file name where the assertion is called</li>
  <li><code class="highlighter-rouge">line</code> - The line number where the assertion is called</li>
</ul>

<p>The <code class="highlighter-rouge">stack</code> property should be a string stack trace similar to those
found on <code class="highlighter-rouge">Error</code> objects.</p>

<p>For best results, calculate these values using the
<a href="http://npm.im/stack-utils">stack-utils</a> module.</p>

</section>
<script src="../static/prism.js"></script>
</body>
