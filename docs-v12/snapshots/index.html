<!doctype html>
<title>
  
    Testing with Snapshots | Node Tap
  
</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html {
  display: block;
  font-family: sans-serif;
  padding: 0 1em;
  margin: 0 auto;
  border-top: 10px solid #f7df1e;
  line-height:1.5;
  color:#333;
  position:relative;
}

html::before {
  width:100%;
  display:block;
  position:fixed;
  top:0;
  left:0;
  height:10px;
  background:#f7df1e;
  content: " ";
}

body {
  padding:0;
  margin: 0;
}

a:hover, a:active, a:focus {
  color: red;
}

code, pre, kbd {
  font-size: 100%;
  font-family: Triplicate T4, Fira Mono OT, Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

section.side {
  display: block;
  padding:0;
  min-height:100px;
  margin: 0;
  width:100%;
}

.side h2, .side p {
  margin-top: 0;
}

section.side li {
  display: inline;
}

section.side ul {
  display: block;
  overflow:auto;
}

section.side li ul {
  display: inline;
}

.side ul {
  padding:0;
  margin:0 ;
}

.side img {
  display: block;
  margin-right: 1em;
  margin-top: 1em;
}

section.main {
  display: block;
  padding-top:20px;
}

@media only screen and (min-width: 240px) {
  .side img {
    float:left;
    margin: 0 1em 0 0;
  }
}

@media only screen and (min-width: 800px) {
  html {
    width:600px;
    padding:0 0 0 200px;
  }
  section.side {
    width: 200px;
    position: fixed;
    margin: 0 0 0 -200px;
  }
  .side img {
    display: block;
    float:none;
  }

  section.side ul {
    overflow: none;
    display: block;
  }

  section.side li {
    display: block;
  }

  section.side a {
    display: block;
  }

  section.side li ul {
    margin: 0;
    display: block;
  }

  section.side li li {
    margin-left: 1em;
  }

  .side h2, .side p {
    margin-top: 1em;
  }

  section.main {
    float: right;
    width: 600px;
    padding-bottom: 100px;
  }
}
</style>
<link href="../static/prism.css" rel="stylesheet">

<body>

<section class='side'>
  <h2><a href="../index.html"><img src='../static/tapjs.png' width=100 height=100 alt='Test Anything JS'></a></h2>
  <p>A Test-Anything-Protocol library for Node.js</p>
  <ul>
  
    <li>
      <a href="../index.html">Index</a>
      
    </li>
  
    <li>
      <a href="../basics/index.html">Getting Started</a>
      
    </li>
  
    <li>
      <a href="../api/index.html">API</a>
      
      <ul>
        
        <li><a href="../asserts/index.html">Asserts</a></li>
        
        <li><a href="../promises/index.html">Promises</a></li>
        
        <li><a href="../subtests/index.html">Subtests</a></li>
        
        <li><a href="../parallel/index.html">Parallel Tests</a></li>
        
        <li><a href="index.html">Snapshot Testing</a></li>
        
        <li><a href="../grep/index.html">Filtering Tests: grep</a></li>
        
        <li><a href="../only/index.html">Filtering Tests: only</a></li>
        
        <li><a href="../mochalike/index.html">Mocha-like DSL</a></li>
        
        <li><a href="../advanced/index.html">Advanced</a></li>
        
      </ul>
      
    </li>
  
    <li>
      <a href="../cli/index.html">CLI</a>
      
    </li>
  
    <li>
      <a href="../tap-format.1">The Protocol</a>
      
    </li>
  
    <li>
      <a href="../reporting/index.html">Reporting</a>
      
    </li>
  
    <li>
      <a href="../coverage/index.html">Coverage</a>
      
    </li>
  
    <li>
      <a href="../changelog/index.html">Change Log</a>
      
    </li>
  
    <li>
      <a href="https://github.com/tapjs/node-tap">GitHub Repo</a>
      
    </li>
  
  </ul>
  <pre><a href="http://npm.im/tap">npm install tap</a>
<a href="../cli/index.html">tap test/*.js</a></pre>
</section>
<section class='main'>
<h1 id="testing-with-snapshots">Testing with Snapshots</h1>

<p>As of version 11, tap supports saving and then comparing against
“snapshot” strings.  This is a powerful technique for testing programs
that generate output, but it comes with some caveats.</p>

<h2 id="basics-of-output-testing">Basics of Output Testing</h2>

<p>Consider a test program like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'&lt;'</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s1">'&gt;'</span> <span class="o">+</span> <span class="nx">contents</span> <span class="o">+</span> <span class="s1">'&lt;/'</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s1">'&gt;'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We might have a test like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">tagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./index.js'</span><span class="p">)</span>
<span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">tagger</span><span class="p">(</span><span class="s1">'tagName'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">),</span> <span class="s1">'&lt;tagName&gt;content&lt;/tagName&gt;'</span><span class="p">)</span>
</code></pre></div></div>

<p>This is good for a couple of reasons:</p>

<ol>
  <li>It’s clear reading our test what the expected output is.</li>
  <li>We’re unlikely to create a test without thinking carefully about
what <em>exactly</em> it’s testing.</li>
</ol>

<p>However, managing strings like this can become extremely tedious,
especially in cases where the output is long, or there are many cases
to test.  If we make an <em>intentional</em> change to the output, then we
need to manually update a large number of large strings, scattered
throughout the test suite.  The inevitable result is that we either
make the tests less comprehensive, or even worse, treat some as “known
failures”.</p>

<h2 id="testing-output-with-snapshots">Testing Output with Snapshots</h2>

<p>We could also write our test file like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">tagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./index.js'</span><span class="p">)</span>
<span class="nx">t</span><span class="p">.</span><span class="nx">matchSnapshot</span><span class="p">(</span><span class="nx">tagger</span><span class="p">(</span><span class="s1">'tagName'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">),</span> <span class="s1">'output'</span><span class="p">)</span>
</code></pre></div></div>

<p>But wait, where is the expected output?</p>

<p>To create the snapshot file, we run this command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ TAP_SNAPSHOT=1 tap test.js
test.js ............................................... 1/1
total ................................................. 1/1

  1 passing (207.826ms)

  ok
</code></pre></div></div>

<p>By setting <code class="highlighter-rouge">TAP_SNAPSHOT</code> in the environment, we tell tap to write the
output to a special file, and treat the assertion as automatically
passing.</p>

<p>The generated file is designed to be human-readable, but you should
not edit it directly.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat tap-snapshots/test.js-TAP.test.js
/* IMPORTANT
 * This snapshot file is auto-generated, but designed for humans.
 * It should be checked into source control and tracked carefully.
 * Re-generate by setting TAP_SNAPSHOT=1 and running tests.
 * Make sure to inspect the output below.  Do not ignore changes!
 */
'use strict'
exports[`test.js TAP &gt; output 1`] = `
&lt;tagName&gt;content&lt;/tagName&gt;
</code></pre></div></div>

<p>The filename is derived from the name of the test file.  The headings
of each string output are based on the names of your tests and
assertions, and given a numeric index to handle collisions.</p>

<h2 id="snapshotting-non-strings">Snapshotting non-Strings</h2>

<p>If the argument passed to <code class="highlighter-rouge">t.matchSnapshot()</code> isn’t a string, then it
will be converted to a string using Node.js’s <code class="highlighter-rouge">util.inspect</code>.  This is
typically pretty easy for humans to understand, but of course if you
prefer to use <code class="highlighter-rouge">JSON.stringify</code> or something else, you can do so easily
enough.</p>

<h2 id="caveats">Caveats</h2>

<h3 id="track-changes">Track Changes</h3>

<p><strong>Important: you should check the snapshot file into source control!</strong></p>

<p>When there are changes to it, inspect the diff and make sure that
nothing unexpected happened to change your output.</p>

<p>If you don’t check this file into source control, then a significant
part of your test is not checked in.  This prevents people from
collaborating on your project.</p>

<p>If you accept changes to it without care, then you can obscure
unintended changes.  (Though, even if this happens, <code class="highlighter-rouge">git bisect</code> can
track down the source of the change quite quickly, so it’s not the end
of the world if there are occasional mistakes.)</p>

<h3 id="strip-variables-from-output">Strip Variables from Output</h3>

<p>If your output includes data that is known to change from one run to
the next, then these changes should be stripped before matching
against a snapshot.</p>

<p>This includes process IDs, time stamps, and many other system details.</p>

<p>Consider this function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">msgTime</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">msg</span> <span class="o">+</span> <span class="s1">' time='</span> <span class="o">+</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Since the output will obviously be slightly different every time the
function is tested, we need to strip out the time value.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">clean</span> <span class="p">(</span><span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ time=</span><span class="se">[</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+$/g</span><span class="p">,</span> <span class="s1">' time={time}'</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">msgTime</span><span class="p">(</span><span class="s1">'this is a test'</span><span class="p">)</span>
<span class="nx">t</span><span class="p">.</span><span class="nx">matchSnapshot</span><span class="p">(</span><span class="nx">clean</span><span class="p">(</span><span class="nx">output</span><span class="p">),</span> <span class="s1">'add timestamp to message'</span><span class="p">)</span>
</code></pre></div></div>

<p>When run with <code class="highlighter-rouge">TAP_SNAPSHOT=1</code>, it generates this snapshot file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">exports</span><span class="p">[</span><span class="s2">`test.js TAP &gt; add timestamp to message 1`</span><span class="p">]</span> <span class="o">=</span> <span class="s2">`
this is a test time={time}
`</span>
</code></pre></div></div>

</section>
<script src="../static/prism.js"></script>
</body>
