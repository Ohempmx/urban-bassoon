<!doctype html>
<title>
  
    Promises | Node Tap
  
</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html {
  display: block;
  font-family: sans-serif;
  padding: 0 1em;
  margin: 0 auto;
  border-top: 10px solid #f7df1e;
  line-height:1.5;
  color:#333;
  position:relative;
}

html::before {
  width:100%;
  display:block;
  position:fixed;
  top:0;
  left:0;
  height:10px;
  background:#f7df1e;
  content: " ";
}

body {
  padding:0;
  margin: 0;
}

a:hover, a:active, a:focus {
  color: red;
}

code, pre, kbd {
  font-size: 100%;
  font-family: Triplicate T4, Fira Mono OT, Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

section.side {
  display: block;
  padding:0;
  min-height:100px;
  margin: 0;
  width:100%;
}

.side h2, .side p {
  margin-top: 0;
}

section.side li {
  display: inline;
}

section.side ul {
  display: block;
  overflow:auto;
}

section.side li ul {
  display: inline;
}

.side ul {
  padding:0;
  margin:0 ;
}

.side img {
  display: block;
  margin-right: 1em;
  margin-top: 1em;
}

section.main {
  display: block;
  padding-top:20px;
}

@media only screen and (min-width: 240px) {
  .side img {
    float:left;
    margin: 0 1em 0 0;
  }
}

@media only screen and (min-width: 800px) {
  html {
    width:600px;
    padding:0 0 0 200px;
  }
  section.side {
    width: 200px;
    position: fixed;
    margin: 0 0 0 -200px;
  }
  .side img {
    display: block;
    float:none;
  }

  section.side ul {
    overflow: none;
    display: block;
  }

  section.side li {
    display: block;
  }

  section.side a {
    display: block;
  }

  section.side li ul {
    margin: 0;
    display: block;
  }

  section.side li li {
    margin-left: 1em;
  }

  .side h2, .side p {
    margin-top: 1em;
  }

  section.main {
    float: right;
    width: 600px;
    padding-bottom: 100px;
  }
}
</style>
<link href="../static/prism.css" rel="stylesheet">

<body>

<section class='side'>
  <h2><a href="../index.html"><img src='../static/tapjs.png' width=100 height=100 alt='Test Anything JS'></a></h2>
  <p>A Test-Anything-Protocol library for Node.js</p>
  <ul>
  
    <li>
      <a href="../index.html">Index</a>
      
    </li>
  
    <li>
      <a href="../basics/index.html">Getting Started</a>
      
    </li>
  
    <li>
      <a href="../api/index.html">API</a>
      
      <ul>
        
        <li><a href="../asserts/index.html">Asserts</a></li>
        
        <li><a href="index.html">Promises</a></li>
        
        <li><a href="../subtests/index.html">Subtests</a></li>
        
        <li><a href="../parallel/index.html">Parallel Tests</a></li>
        
        <li><a href="../snapshots/index.html">Snapshot Testing</a></li>
        
        <li><a href="../grep/index.html">Filtering Tests: grep</a></li>
        
        <li><a href="../only/index.html">Filtering Tests: only</a></li>
        
        <li><a href="../mochalike/index.html">Mocha-like DSL</a></li>
        
        <li><a href="../advanced/index.html">Advanced</a></li>
        
      </ul>
      
    </li>
  
    <li>
      <a href="../cli/index.html">CLI</a>
      
    </li>
  
    <li>
      <a href="../tap-format.1">The Protocol</a>
      
    </li>
  
    <li>
      <a href="../reporting/index.html">Reporting</a>
      
    </li>
  
    <li>
      <a href="../coverage/index.html">Coverage</a>
      
    </li>
  
    <li>
      <a href="../changelog/index.html">Change Log</a>
      
    </li>
  
    <li>
      <a href="https://github.com/tapjs/node-tap">GitHub Repo</a>
      
    </li>
  
  </ul>
  <pre><a href="http://npm.im/tap">npm install tap</a>
<a href="../cli/index.html">tap test/*.js</a></pre>
</section>
<section class='main'>
<h1 id="promises">Promises</h1>

<p>The <code class="highlighter-rouge">t.test()</code>, <code class="highlighter-rouge">t.spawn()</code> and <code class="highlighter-rouge">t.stdin()</code> methods all return a
Promise which resolves to the <code class="highlighter-rouge">t</code> object once the child test, process,
or input stream is done.  (Note that the returned Promise does <em>not</em>
resolve to the <em>child</em> object, because the child is already ended when
control returns to the parent.)</p>

<p>Additionally, if the function passed to <code class="highlighter-rouge">t.test()</code> <em>returns</em> a
Promise, then the child test will be ended when the Promise resolves,
or failed when it is rejected.</p>

<p>These two features together mean that you can string together Promise
chains in your tests, if that’s a thing you’re into.</p>

<p>If you do use a lot of Promises to chain your tests in a long
declarative list, it’s a good idea to put <code class="highlighter-rouge">.catch(t.threw)</code> at the
end, so that any unhandled rejections will be bubbled up to the top
level handler rather than being ignored or reported in a less helpful
manner.</p>

<p>Here is an example:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>
<span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'get thing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">getSomeThing</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check result'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">)</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">getTwoThings</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">things</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'the things'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">things</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">makeSomeOtherPromise</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">otherPromiseResult</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check other promise thing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">otherPromiseResult</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'it should be seven'</span><span class="p">)</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">threw</span><span class="p">)</span>
</code></pre></div></div>

<p>If this sort of style offends you, you are welcome to ignore it.  It’s
not mandatory.</p>

<p>If you want to pass Promises to <a href="../asserts/index.html">assertions</a> and have them
auto-resolve, then check out <a href="http://npm.im/tapromise">tapromise</a>.</p>

<h2 id="rejected-promise">Rejected promise</h2>

<p>To verify that a promise is rejected, you can use the
<a href="../asserts/index.html#trejectspromise--fn-expectederror-message-extra"><code class="highlighter-rouge">t.rejects()</code></a>
function.</p>

<h2 id="asyncawait"><code class="highlighter-rouge">async</code>/<code class="highlighter-rouge">await</code></h2>

<p>Because <code class="highlighter-rouge">async</code> functions return a Promise, you can use them out of
the box with node-tap.  If you pass an <code class="highlighter-rouge">async</code> function as the
<code class="highlighter-rouge">t.test()</code> callback, then tap will detect the promise return and move
onto the next test once the async function has completely resolved.</p>

<p>The above example could be written like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>
<span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'get thing'</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getSomeThing</span><span class="p">()</span>
  <span class="kr">await</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check result'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">things</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getTwoThings</span><span class="p">()</span>
  <span class="kd">var</span> <span class="nx">otherPromiseResult</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'the things'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">things</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">makeSomeOtherPromise</span><span class="p">()</span>
  <span class="p">})</span>
  <span class="kr">await</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check other promise thing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">otherPromiseResult</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'it should be seven'</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">threw</span><span class="p">)</span>
</code></pre></div></div>

<p>Because subtests return promises, you can also <code class="highlighter-rouge">await</code> them to do
things in between subtests.  However, this requires a top-level async
function.</p>

<p>For example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">)</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'get thing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getSomeThing</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check result'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">)</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>
  <span class="kd">var</span> <span class="nx">things</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getTwoThings</span><span class="p">()</span>
  <span class="kd">var</span> <span class="nx">otherPromiseResult</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'got two things'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">things</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">makeSomeOtherPromise</span><span class="p">()</span>
  <span class="p">})</span>
  <span class="kr">await</span> <span class="nx">t</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check other promise thing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">otherPromiseResult</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'it should be seven'</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  <span class="p">})</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'tests are all done!'</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">main</span><span class="p">()</span>
</code></pre></div></div>

</section>
<script src="../static/prism.js"></script>
</body>
